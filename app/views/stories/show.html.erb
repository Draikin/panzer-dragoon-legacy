<% title @story.name %>
<% description @story.description %>

<% if !@story.publish %>
  <span class="label label-warning">Unpublished</span>
<% elsif !@story.category.publish %>
  <span class="label label-warning">Published in Unpublished Category</span>
<% end %>

<% if policy(Story).new? || policy(@story).edit? || policy(@story).destroy? %>
  <div class="btn-group" role="group">
    <% if policy(Story).new? %>
      <%= link_to 'New Story',
        new_story_path(category: @story.category),
        { class: 'btn btn-secondary', role: 'button' }
      %>
    <% end %>
    <% if policy(@story).edit? %>
      <%= link_to 'New Chapter',
        new_chapter_path(story: @story),
        { class: 'btn btn-secondary', role: 'button' }
      %>
    <% end %>
    <% if policy(@story).edit? %>
      <%= link_to 'Edit Story',
        edit_story_path(@story),
        { class: 'btn btn-secondary', role: 'button' }
      %>
    <% end %>
    <% if policy(@story).destroy? %>
      <%= link_to 'Delete Story',
        @story,
        data: { confirm: 'Are you sure you want to delete this story? " +
          "ALL chapters belonging to this story will be deleted.' },
        method: :delete,
        class: 'btn btn-danger',
        role: 'button'
      %>
    <% end %>
  </div>
<% end %>

<h2>Written By:</h2>
<ul>
  <% @story.contributor_profiles.each do |contributor_profile| %>
    <li><%= link_to contributor_profile.name, contributor_profile %></li>
  <% end %>
</ul>

<%= raw illustrated_markdown_to_html @story.id, "Story", @story.content %>

<% if @story.chapters.count > 0 %>
  <h2>Table of Contents:</h2>
  <ul>
  <% @story.chapters.where(chapter_type: :prologue).order(:number).
    each do |prologue| %>
    <li>
      <%= link_to prologue.name, chapter_path(prologue) %>
    </li>
  <% end %>
  <% @story.chapters.where(chapter_type: :regular_chapter).order(:number).
    each do |regular_chapter| %>
    <li>
      <% unless regular_chapter.name.blank? %>
        <%= link_to "Chapter " + regular_chapter.number.to_s + ": " +
          regular_chapter.name, chapter_path(regular_chapter) %>
      <% else %>
        <%= link_to "Chapter " + regular_chapter.number.to_s,
          chapter_path(regular_chapter) %>
      <% end %>
    </li>
  <% end %>
  <% @story.chapters.where(chapter_type: :epilogue).order(:number).
    each do |epilogue| %>
    <li>
      <%= link_to epilogue.name, chapter_path(epilogue) %>
    </li>
  <% end %>
  </ul>
<% end %>

<%= render 'shared/show/related_encyclopaedia_entries' %>

<ol class="breadcrumb">
  <li><%= link_to 'Home', root_url %></li>
  <li><%= link_to 'Stories', stories_path %></li>
  <li>
    <%= link_to @story.category.name,
      category_path(@story.category)
    %>
  </li>
  <li class="active"><%= @story.name %></li>
</ol>
